name: $(date:yyyyMMdd)$(rev:.r)

resources:
  repositories:
  - repository: self
    type: git
    ref: master

trigger:
  batch: true
  branches: { include: [master] }

pr:
  autoCancel: true
  branches: { include: [master] }

pool:
  vmImage: windows-latest

variables:
  disable.coverage.autogenerate: true
  DOTNET_NOLOGO: true
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

steps:
- checkout: self
- pwsh: |
    $env:DOTNET_INSTALL_DIR = Join-Path $env:ProgramFiles 'dotnet'
    Invoke-Expression "& { $(Invoke-RestMethod https://dotnet.microsoft.com/download/dotnet/scripts/v1/dotnet-install.ps1) } -JsonFile ./global.json"
  displayName: Setup dotnet (pinned)
- pwsh: |
    . ./build/startNativeExecution.ps1
    Start-NativeExecution { dotnet build ./tests/Mawosoft.MissingCoverage.Tests/Mawosoft.MissingCoverage.Tests.csproj -c Debug /p:TargetFrameworks=net6.0 }
  displayName: Build
  env:
    MSBuildDebugEngine: 1 # Auto-creates binlogs in ./MSBuild_Logs
    # Fix incomplete binlogs in MSBuild <=17.3.x. See https://github.com/mawosoft/Mawosoft.Extensions.BenchmarkDotNet/issues/146
    MSBUILDLOGTASKINPUTS: 1
    MSBUILDTARGETOUTPUTLOGGING: true
    MSBUILDLOGIMPORTS: 1
    MSBUILDLOGALLENVIRONMENTVARIABLES: true
- pwsh: ./build/test.ps1 -p ./tests/Mawosoft.MissingCoverage.Tests/Mawosoft.MissingCoverage.Tests.csproj -c Debug -f net6.0 -v detailed -r ./TestResults
  displayName: Test
